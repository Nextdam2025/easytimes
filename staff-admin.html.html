<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Easy Times — Staff Console</title>
  <meta name="theme-color" content="#f26522" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23f26522'/%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0a0a0a; color:#faf7ef; -webkit-tap-highlight-color: transparent; }
    .card { background:#121212; border:2px solid #f26522; border-radius:16px; }
    .btn  { background:linear-gradient(145deg,#f26522,#ff7e29); color:#000; font-weight:800; }
    .btn:disabled{ opacity:.5; filter:grayscale(1); }
    .pill { border:2px solid #f26522; border-radius:999px; padding:.4rem .9rem; }
    .row:hover { background: rgba(242,101,34,.05); }
    .switch { position:relative; display:inline-block; width:52px; height:30px; }
    .switch input{ opacity:0; width:0; height:0; }
    .slider{ position:absolute; inset:0; cursor:pointer; background:#333; transition:.2s; border-radius:999px; border:1px solid #555; }
    .slider:before{ content:""; position:absolute; height:22px; width:22px; left:4px; top:3px; background:#fff; border-radius:50%; transition:.2s; }
    input:checked + .slider { background:#f26522; }
    input:checked + .slider:before { transform: translateX(22px); }
    .modal-bg{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal{ width:min(600px,92vw); background:#0f0f0f; border:2px solid #f26522; border-radius:16px; }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="sticky top-0 z-30 border-b border-orange-500/40 bg-black/70 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-full" style="background:radial-gradient(circle at 30% 30%,#ffb17a,#f26522 60%,#4a1c00)"></div>
      <div class="flex-1">
        <h1 class="text-xl font-extrabold tracking-wide">Easy Times — Staff Console</h1>
        <p class="text-xs text-orange-300/80">Update prices • Mark items sold out • Toggle service mode • <span class="font-bold">Add/Remove articles</span></p>
      </div>
      <button id="saveBtn" class="btn px-4 py-2 rounded-xl text-sm disabled:cursor-not-allowed" disabled>💾 Save</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto w-full px-4 py-6 grid gap-6">
    <section class="card p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-5">
          <div>
            <div class="text-sm text-orange-300/80">Service mode</div>
            <div class="mt-1 inline-flex items-center gap-2">
              <button id="modeCounter" class="pill text-sm" aria-pressed="true">Counter</button>
              <button id="modePickup"  class="pill text-sm">Self-Pickup</button>
            </div>
          </div>
          <div class="hidden md:block w-px h-10 bg-orange-500/30"></div>
          <div>
            <div class="text-sm text-orange-300/80">Last loaded</div>
            <div id="lastLoaded" class="mt-1 text-sm">—</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="reloadBtn" class="pill text-sm">↻ Reload</button>
        </div>
      </div>
    </section>

    <section class="card p-4">
      <div class="flex flex-col md:flex-row items-start md:items-center gap-3 justify-between">
        <div class="flex items-center gap-3">
          <input id="search" class="px-3 py-2 rounded-xl bg-black/60 border border-orange-500/30 w-64" placeholder="Search name">
          <div class="text-sm text-orange-300/80">Quick raise (visible)</div>
          <button data-bulk="-0.5" class="pill text-sm">−0.5</button>
          <button data-bulk="0.5"  class="pill text-sm">+0.5</button>
          <button data-bulk="1"    class="pill text-sm">+1</button>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm flex items-center gap-2">
            <input id="showOnlyAvailable" type="checkbox" class="scale-125"> Show only available
          </label>
          <button id="addArticleBtn" class="btn px-3 py-2 rounded-xl text-sm">+ Add Article</button>
        </div>
      </div>
    </section>

    <section class="card overflow-hidden">
      <table class="w-full text-left">
        <thead class="bg-black/60">
          <tr class="text-orange-300/90">
            <th class="px-4 py-3">ID/SKU</th>
            <th class="px-4 py-3">Name</th>
            <th class="px-4 py-3">Category</th>
            <th class="px-4 py-3">Price (€)</th>
            <th class="px-4 py-3">Available</th>
            <th class="px-4 py-3">Quick</th>
            <th class="px-4 py-3">Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-xl border border-green-500/60 bg-green-700 text-white font-bold">Saved!</div>

  <!-- Add Article Modal -->
  <div id="modalBg" class="modal-bg">
    <div class="modal">
      <div class="flex items-center justify-between px-4 py-3 border-b border-orange-500/30">
        <h3 class="font-extrabold">Add Article</h3>
        <button id="closeModal" class="pill text-sm">✕</button>
      </div>
      <div class="p-4 grid gap-3">
        <div class="grid md:grid-cols-3 gap-3">
          <label class="text-sm">SKU / ID
            <input id="newId" class="w-full mt-1 px-3 py-2 rounded-xl bg-black/60 border border-orange-500/30" placeholder="e.g., RB-LIGHT-250">
          </label>
          <label class="text-sm md:col-span-2">Name
            <input id="newName" class="w-full mt-1 px-3 py-2 rounded-xl bg-black/60 border border-orange-500/30" placeholder="Red Bull Light (Sugarfree)">
          </label>
        </div>
        <div class="grid md:grid-cols-3 gap-3">
          <label class="text-sm">Category
            <select id="newCat" class="w-full mt-1 px-3 py-2 rounded-xl bg-black/60 border border-orange-500/30"></select>
          </label>
          <label class="text-sm">Start price (€)
            <input id="newPrice" type="number" step="0.1" min="0" class="w-full mt-1 px-3 py-2 rounded-xl bg-black/60 border border-orange-500/30" placeholder="5.0">
          </label>
          <div class="flex items-end"><button id="confirmAdd" class="btn px-4 py-2 rounded-xl w-full">Add</button></div>
        </div>
        <p class="text-xs text-orange-300/70">IDs must be unique. New articles are <b>Available</b> by default.</p>
      </div>
    </div>
  </div>

    // ------- State -------
    let cfg = await getConfig();            // {schema, version, categories[], articles[]...}
    let dirty = false;
    const els = id => document.getElementById(id);

    // ------- UI helpers -------
    const euro = n => Number(n||0).toFixed(2);
    function setDirty(v=true){ dirty=v; els('saveBtn').disabled = !dirty; }
    function toast(msg='Saved!'){ const t=els('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1600); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    function categoryMap(){
      return Object.fromEntries((cfg.categories||[]).map(c=>[c.id, c.title || c.id]));
    }

    function hydrateCategorySelect(){
      const map = categoryMap();
      els('newCat').innerHTML = Object.entries(map).map(([id,title]) =>
        `<option value="${escapeHtml(id)}">${escapeHtml(title)}</option>`).join('');
    }

    // ------- Render rows from cfg.articles -------
    function render(){
      const q = (els('search').value||'').toLowerCase().trim();
      const onlyAvail = els('showOnlyAvailable').checked;
      const cats = categoryMap();

      const rows = (cfg.articles||[])
        .filter(a => (!q || `${a.id} ${a.sku||''} ${a.name}`.toLowerCase().includes(q)))
        .filter(a => !onlyAvail || a.active !== false)
        .sort((a,b) => (a.sort??999) - (b.sort??999))
        .map(a => {
          const avail = a.active !== false;
          return `
          <tr class="row border-t border-orange-500/20" data-id="${escapeHtml(a.id)}">
            <td class="px-4 py-3 font-bold text-orange-300/90">${escapeHtml(a.sku || a.id)}</td>
            <td class="px-4 py-3">${escapeHtml(a.name)}</td>
            <td class="px-4 py-3 text-sm text-orange-300/80">${escapeHtml(cats[a.categoryId] || a.categoryId || '')}</td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-2">
                <button class="pill text-sm px-2 py-1" data-step="-0.5">−0.5</button>
                <input type="number" step="0.1" min="0" value="${euro(a.price)}"
                       class="price w-28 px-3 py-2 rounded-xl bg-black/60 border border-orange-500/30">
                <button class="pill text-sm px-2 py-1" data-step="0.5">+0.5</button>
              </div>
            </td>
            <td class="px-4 py-3">
              <label class="switch">
                <input type="checkbox" class="avail" ${avail ? 'checked' : ''}>
                <span class="slider"></span>
              </label>
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-2">
                <button class="pill text-sm px-2 py-1" data-step="-0.1">−0.1</button>
                <button class="pill text-sm px-2 py-1" data-step="+0.1">+0.1</button>
                <button class="pill text-sm px-2 py-1" data-step="+1">+1</button>
              </div>
            </td>
            <td class="px-4 py-3">
              <button class="pill text-sm px-2 py-1 text-red-300/90" data-action="delete">🗑 Delete</button>
            </td>
          </tr>`;
        }).join('');

      els('rows').innerHTML = rows || `<tr><td class="px-4 py-6 text-orange-300/70" colspan="7">No items.</td></tr>`;
      els('lastLoaded').textContent = new Date().toLocaleString();
    }

    // ------- Subscriptions / hot reload -------
    subscribeConfig(next => {
      cfg = structuredClone(next);
      render();
      setDirty(false);
    });

    // ------- Events -------
    els('reloadBtn').addEventListener('click', async () => {
      cfg = await getConfig(true);
      render();
      setDirty(false);
    });

    els('saveBtn').addEventListener('click', async () => {
      // read current UI into cfg.articles
      const map = new Map((cfg.articles||[]).map(a => [String(a.id), a]));
      document.querySelectorAll('#rows tr[data-id]').forEach(tr => {
        const id = tr.getAttribute('data-id');
        const price = Number(tr.querySelector('input.price').value);
        const avail = tr.querySelector('input.avail').checked;
        const a = map.get(id);
        if (a) { a.price = price; a.active = avail; }
      });

      const next = { ...cfg, version: Number(cfg.version||0) + 1, updatedAt: new Date().toISOString(), updatedBy: 'staff-admin' };
      const res = await saveConfig(next, { expectedVersion: cfg.version });
      if (!res.ok && res.reason === 'version-conflict') {
        alert('Config changed elsewhere. Reloaded latest; please re-apply your edits.');
        return;
      }
      toast('Saved!');
      setDirty(false);
    });

    // table interactions
    els('rows').addEventListener('click', e => {
      const stepBtn = e.target.closest('[data-step]');
      if (stepBtn) {
        const tr = e.target.closest('tr');
        const inp = tr.querySelector('input.price');
        const delta = Number(stepBtn.getAttribute('data-step'));
        inp.value = (Number(inp.value) + delta).toFixed(2);
        setDirty(true);
      }
      const delBtn = e.target.closest('[data-action="delete"]');
      if (delBtn) {
        const tr = e.target.closest('tr');
        const id = tr.getAttribute('data-id');
        if (confirm(`Delete article ${id}?`)) {
          cfg.articles = cfg.articles.filter(a => String(a.id) !== id);
          render(); setDirty(true);
        }
      }
    });
    els('rows').addEventListener('input', e => {
      if (e.target.matches('input.price') || e.target.matches('input.avail')) setDirty(true);
    });

    // search / filters
    els('search').addEventListener('input', render);
    els('showOnlyAvailable').addEventListener('change', render);

    // service mode (stored in cfg.serviceMode)
    let serviceMode = cfg.serviceMode === 'self_pickup' ? 'self_pickup' : 'counter';
    function updateModeUI(){
      const on = x => x ? 'linear-gradient(145deg,#f26522,#ff7e29)' : 'transparent';
      const onColor = x => x ? '#000' : '#faf7ef';
      const c = serviceMode==='counter';
      document.getElementById('modeCounter').style.background = on(c);
      document.getElementById('modeCounter').style.color = onColor(c);
      document.getElementById('modePickup').style.background = on(!c);
      document.getElementById('modePickup').style.color = onColor(!c);
    }
    updateModeUI();
    document.getElementById('modeCounter').addEventListener('click', ()=>{ serviceMode='counter'; cfg.serviceMode='counter'; updateModeUI(); setDirty(true); });
    document.getElementById('modePickup').addEventListener('click', ()=>{ serviceMode='self_pickup'; cfg.serviceMode='self_pickup'; updateModeUI(); setDirty(true); });

    // add / modal
    const modalBg = document.getElementById('modalBg');
    function openModal(){ modalBg.style.display='flex'; hydrateCategorySelect(); setTimeout(()=>document.getElementById('newId').focus(), 50); }
    function closeModal(){ modalBg.style.display='none'; }
    document.getElementById('addArticleBtn').addEventListener('click', openModal);
    document.getElementById('closeModal').addEventListener('click', closeModal);
    modalBg.addEventListener('click', e => { if (e.target === modalBg) closeModal(); });
    document.getElementById('confirmAdd').addEventListener('click', () => {
      const id = (document.getElementById('newId').value || '').trim();
      const name = (document.getElementById('newName').value || '').trim();
      const cat  = document.getElementById('newCat').value || 'cold';
      const price = Number(document.getElementById('newPrice').value || 0);
      if (!id || !name) return alert('Please fill ID and Name');
      if ((cfg.articles||[]).some(a => String(a.id) === id)) return alert('This ID already exists');

      cfg.articles = [...(cfg.articles||[]), { id, sku:id, name, categoryId:cat, price, vat:0.09, active:true, options:[], sort:999 }];
      render(); setDirty(true); closeModal();
      document.getElementById('newId').value = '';
      document.getElementById('newName').value = '';
      document.getElementById('newPrice').value = '';
    });

    // bulk price raise (visible rows)
    document.querySelectorAll('[data-bulk]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const delta = Number(b.getAttribute('data-bulk'));
        document.querySelectorAll('#rows tr').forEach(tr=>{
          const inp = tr.querySelector('input.price');
          if (inp) inp.value = (Number(inp.value) + delta).toFixed(2);
        });
        setDirty(true);
      });
    });

    // initial render
    render();

    // PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  </script>
  <script type="module">
  import { getConfig, saveConfig, subscribeConfig } from "./live-config.js";

  // --- “Old” defaults (used ONLY if config has no articles) ---
  const DEFAULT_CATEGORIES = [
    { id: "hot",    title: "Hot Drinks",      order: 1 },
    { id: "cold",   title: "Cold Drinks",     order: 2 },
    { id: "snacks", title: "Homemade Snacks", order: 3 },
  ];
  const LEGACY_DEFAULTS = [
    { id: 102, name:'Espresso',                   categoryId:'hot',    price:3.5 },
    { id: 202, name:'Doppio',                     categoryId:'hot',    price:4.0 },
    { id: 203, name:'Black Coffee',               categoryId:'hot',    price:3.5 },
    { id: 204, name:'Americano',                  categoryId:'hot',    price:3.5 },
    { id: 205, name:'Cappuccino',                 categoryId:'hot',    price:4.0 },
    { id: 206, name:'Flavored Latte',             categoryId:'hot',    price:5.0 },
    { id: 207, name:'Café Latte',                 categoryId:'hot',    price:4.5 },
    { id: 208, name:'Latte Macchiato',            categoryId:'hot',    price:4.5 },
    { id: 209, name:'Coffee Mocca',               categoryId:'hot',    price:5.0 },
    { id: 210, name:'Hot Chocolate',              categoryId:'hot',    price:4.0 },
    { id: 301, name:'Tea',                        categoryId:'hot',    price:3.5 },
    { id: 302, name:'Fresh Mint Tea',             categoryId:'hot',    price:4.5 },
    { id: 401, name:'Coca-Cola',                  categoryId:'cold',   price:4.0 },
    { id: 402, name:'Coca-Cola Zero',             categoryId:'cold',   price:4.0 },
    { id: 403, name:'Fanta Orange',               categoryId:'cold',   price:4.0 },
    { id: 404, name:'Fanta Cassis',               categoryId:'cold',   price:4.0 },
    { id: 405, name:'Still Water',                categoryId:'cold',   price:3.5 },
    { id: 406, name:'Sparkling Water',            categoryId:'cold',   price:3.5 },
    { id: 407, name:'Sprite',                     categoryId:'cold',   price:4.0 },
    { id: 408, name:'Chocomel',                   categoryId:'cold',   price:4.0 },
    { id: 409, name:'Iced Tea (Peach/Mango)',     categoryId:'cold',   price:4.0 },
    { id: 410, name:'Iced Tea Lemon Sparkling',   categoryId:'cold',   price:4.0 },
    { id: 411, name:'Royal Bliss Bitter Lemon',   categoryId:'cold',   price:4.0 },
    { id: 412, name:'Royal Bliss Tonic',          categoryId:'cold',   price:4.0 },
    { id: 413, name:'Looza (Pear/Straw/Peach)',   categoryId:'cold',   price:4.0 },
    { id: 414, name:'Minute Maid Orange/Apple',   categoryId:'cold',   price:4.0 },
    { id: 415, name:'AA Energy Drink',            categoryId:'cold',   price:4.0 },
    { id: 416, name:'Red Bull Energy Drink',      categoryId:'cold',   price:5.0 },
    { id: 501, name:'Chocolate Chip Cookie',      categoryId:'snacks', price:3.5 },
    { id: 502, name:'Banana Cake',                categoryId:'snacks', price:4.0 },
  ];
  function toArticle(a) {
    return {
      id: String(a.id),
      sku: String(a.id),
      name: a.name,
      categoryId: a.categoryId,
      price: Number(a.price || 0),
      vat: 0.09,
      active: true,
      options: [],
      sort: 999
    };
  }

  // ------- State -------
  let cfg = await getConfig(); // {schema, version, categories[], articles[]...}
  let dirty = false;
  const els = id => document.getElementById(id);

  // If config is empty, populate with defaults (UI shows items immediately)
  function bootstrapIfEmpty() {
    let touched = false;

    if (!Array.isArray(cfg.categories) || cfg.categories.length === 0) {
      cfg.categories = DEFAULT_CATEGORIES.map(c => ({...c}));
      touched = true;
    }
    if (!Array.isArray(cfg.articles) || cfg.articles.length === 0) {
      cfg.articles = LEGACY_DEFAULTS.map(toArticle);
      touched = true;
    }
    // Ensure each article has required fields
    cfg.articles = cfg.articles.map(a => ({
      id: String(a.id ?? a.sku ?? crypto.randomUUID()),
      sku: String(a.sku ?? a.id),
      name: a.name ?? 'Untitled',
      categoryId: a.categoryId ?? 'cold',
      price: Number(a.price ?? 0),
      vat: a.vat ?? 0.09,
      active: a.active !== false,
      options: Array.isArray(a.options) ? a.options : [],
      sort: Number.isFinite(a.sort) ? a.sort : 999
    }));

    if (touched) setDirty(true); // enable Save so you can persist defaults
  }

  bootstrapIfEmpty();

  // ------- UI helpers -------
  const euro = n => Number(n||0).toFixed(2);
  function setDirty(v=true){ dirty=v; els('saveBtn').disabled = !dirty; }
  function toast(msg='Saved!'){ const t=els('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1600); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  function categoryMap(){
    return Object.fromEntries((cfg.categories||[]).map(c=>[c.id, c.title || c.id]));
  }

  function hydrateCategorySelect(){
    const map = categoryMap();
    els('newCat').innerHTML = Object.entries(map).map(([id,title]) =>
      `<option value="${escapeHtml(id)}">${escapeHtml(title)}</option>`).join('');
  }

  // ------- Render rows from cfg.articles -------
  function render(){
    const q = (els('search').value||'').toLowerCase().trim();
    const onlyAvail = els('showOnlyAvailable').checked;
    const cats = categoryMap();

    const rows = (cfg.articles||[])
      .filter(a => (!q || `${a.id} ${a.sku||''} ${a.name}`.toLowerCase().includes(q)))
      .filter(a => !onlyAvail || a.active !== false)
      .sort((a,b) => (a.sort??999) - (b.sort??999))
      .map(a => {
        const avail = a.active !== false;
        return `
        <tr class="row border-t border-orange-500/20" data-id="${escapeHtml(a.id)}">
          <td class="px-4 py-3 font-bold text-orange-300/90">${escapeHtml(a.sku || a.id)}</td>
          <td class="px-4 py-3">${escapeHtml(a.name)}</td>
          <td class="px-4 py-3 text-sm text-orange-300/80">${escapeHtml(cats[a.categoryId] || a.categoryId || '')}</td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-2">
              <button class="pill text-sm px-2 py-1" data-step="-0.5">−0.5</button>
              <input type="number" step="0.1" min="0" value="${euro(a.price)}"
                     class="price w-28 px-3 py-2 rounded-xl bg-black/60 border border-orange-500/30">
              <button class="pill text-sm px-2 py-1" data-step="0.5">+0.5</button>
            </div>
          </td>
          <td class="px-4 py-3">
            <label class="switch">
              <input type="checkbox" class="avail" ${avail ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
          </td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-2">
              <button class="pill text-sm px-2 py-1" data-step="-0.1">−0.1</button>
              <button class="pill text-sm px-2 py-1" data-step="+0.1">+0.1</button>
              <button class="pill text-sm px-2 py-1" data-step="+1">+1</button>
            </div>
          </td>
          <td class="px-4 py-3">
            <button class="pill text-sm px-2 py-1 text-red-300/90" data-action="delete">🗑 Delete</button>
          </td>
        </tr>`;
      }).join('');

    els('rows').innerHTML = rows || `<tr><td class="px-4 py-6 text-orange-300/70" colspan="7">No items.</td></tr>`;
    els('lastLoaded').textContent = new Date().toLocaleString();
    hydrateCategorySelect();
  }

  // ------- Subscriptions / hot reload -------
  subscribeConfig(next => {
    cfg = structuredClone(next);
    bootstrapIfEmpty();
    render();
    setDirty(false);
  });

  // ------- Events -------
  els('reloadBtn').addEventListener('click', async () => {
    cfg = await getConfig(true);
    bootstrapIfEmpty();
    render();
    setDirty(false);
  });

  els('saveBtn').addEventListener('click', async () => {
    // read current UI into cfg.articles
    const map = new Map((cfg.articles||[]).map(a => [String(a.id), a]));
    document.querySelectorAll('#rows tr[data-id]').forEach(tr => {
      const id = tr.getAttribute('data-id');
      const price = Number(tr.querySelector('input.price').value);
      const avail = tr.querySelector('input.avail').checked;
      const a = map.get(id);
      if (a) { a.price = price; a.active = avail; }
    });

    const next = { ...cfg, version: Number(cfg.version||0) + 1, updatedAt: new Date().toISOString(), updatedBy: 'staff-admin' };
    const res = await saveConfig(next, { expectedVersion: cfg.version });
    if (!res.ok && res.reason === 'version-conflict') {
      alert('Config changed elsewhere. Reloaded latest; please re-apply your edits.');
      return;
    }
    toast('Saved!');
    setDirty(false);
  });

  // table interactions
  els('rows').addEventListener('click', e => {
    const stepBtn = e.target.closest('[data-step]');
    if (stepBtn) {
      const tr = e.target.closest('tr');
      const inp = tr.querySelector('input.price');
      const delta = Number(stepBtn.getAttribute('data-step'));
      inp.value = (Number(inp.value) + delta).toFixed(2);
      setDirty(true);
    }
    const delBtn = e.target.closest('[data-action="delete"]');
    if (delBtn) {
      const tr = e.target.closest('tr');
      const id = tr.getAttribute('data-id');
      if (confirm(`Delete article ${id}?`)) {
        cfg.articles = cfg.articles.filter(a => String(a.id) !== id);
        render(); setDirty(true);
      }
    }
  });
  els('rows').addEventListener('input', e => {
    if (e.target.matches('input.price') || e.target.matches('input.avail')) setDirty(true);
  });

  // search / filters
  els('search').addEventListener('input', render);
  els('showOnlyAvailable').addEventListener('change', render);

  // service mode (stored in cfg.serviceMode)
  let serviceMode = cfg.serviceMode === 'self_pickup' ? 'self_pickup' : 'counter';
  function updateModeUI(){
    const on = x => x ? 'linear-gradient(145deg,#f26522,#ff7e29)' : 'transparent';
    const onColor = x => x ? '#000' : '#faf7ef';
    const c = serviceMode==='counter';
    document.getElementById('modeCounter').style.background = on(c);
    document.getElementById('modeCounter').style.color = onColor(c);
    document.getElementById('modePickup').style.background = on(!c);
    document.getElementById('modePickup').style.color = onColor(!c);
  }
  updateModeUI();
  document.getElementById('modeCounter').addEventListener('click', ()=>{ serviceMode='counter'; cfg.serviceMode='counter'; updateModeUI(); setDirty(true); });
  document.getElementById('modePickup').addEventListener('click', ()=>{ serviceMode='self_pickup'; cfg.serviceMode='self_pickup'; updateModeUI(); setDirty(true); });

  // add / modal
  const modalBg = document.getElementById('modalBg');
  function openModal(){ modalBg.style.display='flex'; hydrateCategorySelect(); setTimeout(()=>document.getElementById('newId').focus(), 50); }
  function closeModal(){ modalBg.style.display='none'; }
  document.getElementById('addArticleBtn').addEventListener('click', openModal);
  document.getElementById('closeModal').addEventListener('click', closeModal);
  modalBg.addEventListener('click', e => { if (e.target === modalBg) closeModal(); });
  document.getElementById('confirmAdd').addEventListener('click', () => {
    const id = (document.getElementById('newId').value || '').trim();
    const name = (document.getElementById('newName').value || '').trim();
    const cat  = document.getElementById('newCat').value || 'cold';
    const price = Number(document.getElementById('newPrice').value || 0);
    if (!id || !name) return alert('Please fill ID and Name');
    if ((cfg.articles||[]).some(a => String(a.id) === id)) return alert('This ID already exists');

    cfg.articles = [...(cfg.articles||[]), { id, sku:id, name, categoryId:cat, price, vat:0.09, active:true, options:[], sort:999 }];
    render(); setDirty(true); closeModal();
    document.getElementById('newId').value = '';
    document.getElementById('newName').value = '';
    document.getElementById('newPrice').value = '';
  });

  // bulk price raise (visible rows)
  document.querySelectorAll('[data-bulk]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const delta = Number(b.getAttribute('data-bulk'));
      document.querySelectorAll('#rows tr').forEach(tr=>{
        const inp = tr.querySelector('input.price');
        if (inp) inp.value = (Number(inp.value) + delta).toFixed(2);
      });
      setDirty(true);
    });
  });

  // initial render
  render();

  // PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
</script>

</body>
</html>


